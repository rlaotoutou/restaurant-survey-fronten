<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>餐饮店盈利AI诊断调查问卷</title>
    <script src="https://cdn.tailwindcss.com/3.3.3"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body {
            font-family: 'Noto Sans SC', sans-serif;
            background-color: #f5f7fa;
            color: #333;
        }
        .form-step {
            display: none;
        }
        .form-step.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .progress-bar {
            height: 6px;
            background-color: #e5e7eb;
            border-radius: 3px;
        }
        .progress-fill {
            height: 100%;
            background-color: #3b82f6;
            border-radius: 3px;
            transition: width 0.3s ease;
        }
        .input-error {
            border-color: #ef4444;
        }
        .error-message {
            color: #ef4444;
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }
        .loading {
            display: none;
        }
        .loading.active {
            display: inline-flex;
            align-items: center;
        }
        .spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3b82f6;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .api-status-compact {
            font-size: 0.875rem;
            padding: 0.5rem 0.75rem;
        }
        .update-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 600;
        }
    </style>
</head>
<body class="min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <div class="bg-white rounded-xl shadow-md overflow-hidden mb-8">
            <div class="p-6">
                <h1 class="text-2xl font-bold text-center text-gray-800 mb-2">餐饮店盈利AI诊断调查问卷</h1>
                <p class="text-center text-gray-600 mb-6" id="formSubtitle">输入门店识别码,开始或更新您的诊断数据</p>
                
                <div class="mb-4 p-2 rounded-lg api-status-compact" id="apiStatus">
                    <div class="flex items-center justify-center">
                        <div class="w-2 h-2 rounded-full mr-2" id="statusIndicator"></div>
                        <span id="statusText" class="text-sm">正在连接后端服务...</span>
                    </div>
                </div>
                
                <div class="progress-bar mb-8">
                    <div class="progress-fill" style="width: 0%"></div>
                </div>
                
                <div class="form-steps">
                    <div class="form-step active" id="step0">
                        <h2 class="text-xl font-semibold mb-4 flex items-center">
                            <span class="w-8 h-8 rounded-full bg-blue-500 text-white flex items-center justify-center mr-3">
                                <i class="fas fa-fingerprint"></i>
                            </span>
                            身份验证
                        </h2>
                        <p class="text-gray-600 mb-6">请输入您的门店唯一识别码以开始。如果您是新用户,系统将为您创建档案;如果是老用户,将加载您之前的数据。</p>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-gray-700 mb-1">门店识别码 <span class="text-red-500">*</span></label>
                                <input type="text" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                       placeholder="例如:餐厅全名或营业执照号" id="storeIdentifier" required>
                                <p class="text-gray-500 text-sm mt-1">此识别码是您店铺的唯一凭证,请谨慎填写并牢记。</p>
                            </div>
                            <div id="identifierMessage" class="mt-4 text-sm"></div>
                        </div>

                        <div class="flex justify-end mt-8">
                             <button id="checkIdentifierBtn" class="px-6 py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 transition-colors">
                                <div class="loading">
                                    <div class="spinner"></div>
                                    验证中...
                                </div>
                                <span class="btn-text">
                                    开始<i class="fas fa-arrow-right ml-2"></i>
                                </span>
                            </button>
                        </div>
                    </div>

                    <div class="form-step" id="step1">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-semibold flex items-center">
                                <span class="w-8 h-8 rounded-full bg-blue-500 text-white flex items-center justify-center mr-3">1</span>
                                基础信息
                            </h2>
                            <span id="updateBadge1" class="update-badge bg-blue-100 text-blue-800" style="display:none;"></span>
                        </div>
                        <p class="text-gray-600 mb-6">用于AI模型识别门店基本属性,为后续诊断提供基准数据</p>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-gray-700 mb-1">门店名称 <span class="text-red-500">*</span></label>
                                <input type="text" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                       placeholder="朝阳路快餐店" id="storeName" required>
                                <p class="text-gray-500 text-sm mt-1">请输入门店全称(如"XX地区XX路XX餐厅")</p>
                            </div>
                            <div>
                                <label class="block text-gray-700 mb-1">业态类型 <span class="text-red-500">*</span></label>
                                <select class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" id="businessType" required>
                                    <option value="">请选择业态类型</option>
                                    <option>快餐</option><option>火锅</option><option>正餐</option><option>茶餐厅</option><option>自助餐</option><option>烧烤</option><option>麻辣烫</option><option>面条</option><option>包子饺子</option><option>粥店</option><option>咖啡厅</option><option>茶饮店</option><option>甜品店</option><option>西餐厅</option><option>日韩料理</option><option>东南亚菜</option><option>小吃摊档</option><option>食堂档口</option><option>酒吧</option><option>夜宵店</option><option>其他</option>
                                </select>
                                <p class="text-gray-500 text-sm mt-1">选择门店主要经营业态,影响行业对比基准</p>
                            </div>
                            <div>
                                <label class="block text-gray-700 mb-1">门店总面积(平方米) <span class="text-red-500">*</span></label>
                                <input type="number" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                       placeholder="120" id="storeArea" required>
                                <p class="text-gray-500 text-sm mt-1">门店总使用面积(含厨房、仓库等)</p>
                            </div>
                            <div>
                                <label class="block text-gray-700 mb-1">门店的本地商圈情况 <span class="text-red-500">*</span></label>
                                <select class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" id="businessCircle" required>
                                    <option value="">请选择商圈情况</option>
                                    <option>一类商场里面</option><option>二类商场里面</option><option>一类商圈</option><option>二类商圈</option><option>一类主街</option><option>二类主街</option><option>一类社区</option><option>二类社区</option>
                                </select>
                                <p class="text-gray-500 text-sm mt-1">选择门店所在的商圈类型</p>
                            </div>
                            <div>
                                <label class="block text-gray-700 mb-1">门店同类型的装修风格档次 <span class="text-red-500">*</span></label>
                                <select class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" id="decorationLevel" required>
                                    <option value="">请选择装修档次</option>
                                    <option>中高档</option><option>中档</option><option>中低档</option>
                                </select>
                                <p class="text-gray-500 text-sm mt-1">中高档/中档/中低档</p>
                            </div>
                            <div>
                                <label class="block text-gray-700 mb-1">营业收入(元/月) <span class="text-red-500">*</span></label>
                                <input type="number" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                       placeholder="150000" id="monthlyRevenue" required>
                                <p class="text-gray-500 text-sm mt-1">月总营业收入(含堂食、外卖及其他收入)</p>
                            </div>
                            <div>
                                <label class="block text-gray-700 mb-1">日均客流(人/天) <span class="text-red-500">*</span></label>
                                <input type="number" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                       placeholder="150" id="dailyCustomers" required>
                                <p class="text-gray-500 text-sm mt-1">平均每天到店消费人数(不含外卖)</p>
                            </div>
                             <div>
                                <label class="block text-gray-700 mb-1">座位数(个) <span class="text-red-500">*</span></label>
                                <input type="number" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                       placeholder="50" id="seats" required>
                                <p class="text-gray-500 text-sm mt-1">门店总座位数量(含散座、包间)</p>
                            </div>
                            <div>
                                <label class="block text-gray-700 mb-1">食材成本(元/月) <span class="text-red-500">*</span></label>
                                <input type="number" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                       placeholder="60000" id="foodCost" required>
                                <p class="text-gray-500 text-sm mt-1">食材采购总成本(含主料、辅料、调料)</p>
                            </div>
                            <div>
                                <label class="block text-gray-700 mb-1">人力成本(元/月) <span class="text-red-500">*</span></label>
                                <input type="number" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                       placeholder="50000" id="laborCost" required>
                                <p class="text-gray-500 text-sm mt-1">所有员工工资、福利、社保总和(不含老板工资)</p>
                            </div>
                            <div>
                                <label class="block text-gray-700 mb-1">租金成本(元/月) <span class="text-red-500">*</span></label>
                                <input type="number" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                       placeholder="30000" id="rentCost" required>
                                <p class="text-gray-500 text-sm mt-1">含房租、物业费、水电费</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-step" id="step2">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-semibold flex items-center">
                                <span class="w-8 h-8 rounded-full bg-blue-500 text-white flex items-center justify-center mr-3">2</span>
                                运营数据
                            </h2>
                            <span id="updateBadge2" class="update-badge bg-blue-100 text-blue-800" style="display:none;"></span>
                        </div>
                        <p class="text-gray-600 mb-6">用于AI模型分析成本结构、营收构成及运营效率</p>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-gray-700 mb-1">线上营收(元/月) <span class="text-red-500">*</span></label>
                                <input type="number" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                       placeholder="60000" id="onlineRevenue" required>
                                <p class="text-gray-500 text-sm mt-1">外卖平台总销售额(含所有外卖渠道)</p>
                            </div>
                            <div>
                                <label class="block text-gray-700 mb-1">线上主营平台 <span class="text-red-500">*</span></label>
                                <input type="text" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                       placeholder="美团、抖音" id="mainPlatforms" required>
                                <p class="text-gray-500 text-sm mt-1">美团,大众点评,抖音,饿了么,京东等,可依次填写二个</p>
                            </div>
                            <div>
                                <label class="block text-gray-700 mb-1">营销情况 <span class="text-red-500">*</span></label>
                                <select class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" id="marketingSituation" required>
                                    <option value="">请选择营销情况</option>
                                    <option>老板运营</option><option>有自己团队</option><option>找代运营</option><option>无</option>
                                </select>
                                <p class="text-gray-500 text-sm mt-1">老板运营,有自己团队,找代运营,无</p>
                            </div>
                            <div>
                                <label class="block text-gray-700 mb-1">总客流(人/月) <span class="text-red-500">*</span></label>
                                <input type="number" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                       placeholder="4500" id="totalCustomers" required>
                                <p class="text-gray-500 text-sm mt-1">每月总接待顾客数量(含新老客户)</p>
                            </div>
                            <div>
                                <label class="block text-gray-700 mb-1">复购的老客户人数(人/月) <span class="text-red-500">*</span></label>
                                <input type="number" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                       placeholder="800" id="repeatCustomers" required>
                                <p class="text-gray-500 text-sm mt-1">有复购行为的老客户人数(需会员系统数据支持)</p>
                            </div>
                            <div>
                                <label class="block text-gray-700 mb-1">水电气成本(元/月) <span class="text-red-500">*</span></label>
                                <input type="number" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                       placeholder="8000" id="utilityCost" required>
                                <p class="text-gray-500 text-sm mt-1">水费、电费、燃气费总和</p>
                            </div>
                            <div>
                                <label class="block text-gray-700 mb-1">营销费用(元/月) <span class="text-red-500">*</span></label>
                                <input type="number" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                       placeholder="15000" id="marketingCost" required>
                                <p class="text-gray-500 text-sm mt-1">含平台推广+达人的费用+找代运营费用,比如1000+1000+0</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-step" id="step3">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-semibold flex items-center">
                                <span class="w-8 h-8 rounded-full bg-blue-500 text-white flex items-center justify-center mr-3">3</span>
                                体验数据
                            </h2>
                            <span id="updateBadge3" class="update-badge bg-blue-100 text-blue-800" style="display:none;"></span>
                        </div>
                        <p class="text-gray-600 mb-6">用于AI模型评估客户满意度及口碑健康度</p>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-gray-700 mb-1">各平台团购均评分(抖音/美团/大众点评) <span class="text-red-500">*</span></label>
                                <input type="number" step="0.1" min="0" max="5" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                       placeholder="3.8" id="averageRating" required>
                                <p class="text-gray-500 text-sm mt-1">综合各平台评分(精确到0.1分)</p>
                            </div>
                            <div>
                                <label class="block text-gray-700 mb-1">总评论数(条/月) <span class="text-red-500">*</span></label>
                                <input type="number" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                       placeholder="400" id="totalReviews" required>
                                <p class="text-gray-500 text-sm mt-1">每月收到的所有评价总数(含好评、中评、差评)</p>
                            </div>
                            <div>
                                <label class="block text-gray-700 mb-1">差评数(条/月) <span class="text-red-500">*</span></label>
                                <input type="number" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                       placeholder="25" id="badReviews" required>
                                <p class="text-gray-500 text-sm mt-1">每月收到的1-2星评价总数</p>
                            </div>
                            <div>
                                <label class="block text-gray-700 mb-1">差评其中的服务差评数(条/月) <span class="text-red-500">*</span></label>
                                <input type="number" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                       placeholder="10" id="serviceBadReviews" required>
                                <p class="text-gray-500 text-sm mt-1">因服务问题导致的差评数量</p>
                            </div>
                            <div>
                                <label class="block text-gray-700 mb-1">差评其中的口味差评数(条/月) <span class="text-red-500">*</span></label>
                                <input type="number" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                       placeholder="8" id="tasteBadReviews" required>
                                <p class="text-gray-500 text-sm mt-1">因口味问题导致的差评数量</p>
                            </div>
                            <div>
                                <label class="block text-gray-700 mb-1">短视频发布量(条/月) <span class="text-red-500">*</span></label>
                                <input type="number" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                       placeholder="80" id="shortVideoCount" required>
                                <p class="text-gray-500 text-sm mt-1">含自己多个账号、达人、顾客的,多个平台发布的总数</p>
                            </div>
                            <div>
                                <label class="block text-gray-700 mb-1">直播场次(次/月) <span class="text-red-500">*</span></label>
                                <input type="number" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                       placeholder="20" id="liveStreamCount" required>
                                <p class="text-gray-500 text-sm mt-1">含有人或无人实景直播,自播及达人的总次数</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-step" id="step4">
                        <div class="max-w-4xl mx-auto">
                            <div class="text-center mb-8">
                                <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <i class="fas fa-check-circle text-green-500 text-4xl"></i>
                                </div>
                                <h1 class="text-3xl font-bold text-gray-800 mb-4" id="successTitle">提交成功!</h1>
                                <p class="text-gray-600" id="successSubtitle">您的调查数据已成功保存,感谢您的参与</p>
                            </div>
                            
                            <div class="bg-green-50 rounded-xl p-6 border border-green-200 mb-8">
                                <div class="text-center">
                                    <h3 class="text-lg font-semibold text-green-800 mb-4">提交详情</h3>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-green-700">
                                        <div>
                                            <span class="font-medium">门店识别码:</span>
                                            <span id="submitIdentifier" class="font-mono ml-2">-</span>
                                        </div>
                                        <div>
                                            <span class="font-medium">提交时间:</span>
                                            <span id="submitTime" class="font-mono ml-2">-</span>
                                        </div>
                                        <div>
                                            <span class="font-medium">剩余修改次数:</span>
                                            <span id="updatesRemaining" class="ml-2">-</span>
                                        </div>
                                        <div>
                                            <span class="font-medium">记录ID:</span>
                                            <span id="recordId" class="font-mono ml-2">-</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="text-center space-y-4">
                                <button id="downloadPDF" class="px-8 py-3 bg-purple-500 text-white rounded-lg hover:bg-purple-600 transition-colors font-medium">
                                    <i class="fas fa-file-pdf mr-2"></i>下载提交数据PDF
                                </button>
                                <div>
                                    <button id="resetForm" class="px-6 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors">
                                        <i class="fas fa-redo mr-2"></i>返回身份验证
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="navigationButtons" class="flex justify-between mt-8">
                    <button id="prevBtn" class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors hidden">
                        <i class="fas fa-arrow-left mr-2"></i>上一步
                    </button>
                    <button id="nextBtn" class="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors ml-auto hidden">
                        下一步<i class="fas fa-arrow-right ml-2"></i>
                    </button>
                    <button id="submitBtn" class="px-6 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors hidden">
                        <div class="loading">
                            <div class="spinner"></div>
                            提交中...
                        </div>
                        <span class="submit-text">
                            <i class="fas fa-check-circle mr-2"></i>提交问卷
                        </span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const CONFIG = {
                API_BASE: 'https://restaurant-survey-backend-postgres.onrender.com',
                DEBUG: true,
                MAX_RETRIES: 3,
                TIMEOUT: 30000
            };
            
            let currentStep = 0;
            let savedData = null;
            let isUpdateMode = false;
            let updatesRemaining = 3;
            let updateCount = 0;
            let storeIdentifierValue = '';

            const { jsPDF } = window.jspdf;
            const steps = document.querySelectorAll('.form-step');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const submitBtn = document.getElementById('submitBtn');
            const progressFill = document.querySelector('.progress-fill');
            const apiStatus = document.getElementById('apiStatus');
            const statusIndicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('statusText');
            const formSubtitle = document.getElementById('formSubtitle');
            const navigationButtons = document.getElementById('navigationButtons');
            
            const storeIdentifierInput = document.getElementById('storeIdentifier');
            const checkIdentifierBtn = document.getElementById('checkIdentifierBtn');
            const identifierMessage = document.getElementById('identifierMessage');

            const successTitle = document.getElementById('successTitle');
            const successSubtitle = document.getElementById('successSubtitle');
            const recordId = document.getElementById('recordId');
            const submitTime = document.getElementById('submitTime');
            const submitIdentifier = document.getElementById('submitIdentifier');
            const updatesRemainingEl = document.getElementById('updatesRemaining');
            const downloadPDF = document.getElementById('downloadPDF');
            const resetForm = document.getElementById('resetForm');
            
            showStep(currentStep);
            initializeApp();
            
            function debugLog(message, data = null) {
                if (CONFIG.DEBUG) console.log('[Survey Debug]', message, data);
            }
            
            async function initializeApp() {
                debugLog('Initializing app with config:', CONFIG);
                if (!CONFIG.API_BASE || CONFIG.API_BASE.includes('your-app')) {
                    updateApiStatus('error', '请在代码中配置正确的API地址');
                    return;
                }
                await checkApiConnection();
            }
            
            async function checkApiConnection() {
                updateApiStatus('checking', '正在连接服务器...');
                try {
                    const response = await fetch(`${CONFIG.API_BASE}/api/health`, { signal: AbortSignal.timeout(CONFIG.TIMEOUT) });
                    if (response.ok) {
                        updateApiStatus('connected', '服务器连接正常');
                        return true;
                    }
                    throw new Error(`HTTP ${response.status}`);
                } catch (error) {
                    let msg = (error.name === 'AbortError' || error.name === 'TimeoutError') ? '请求超时' : '无法连接到服务器';
                    updateApiStatus('error', `连接失败: ${msg}`);
                    return false;
                }
            }
            
            function updateApiStatus(status, message) {
                statusText.textContent = message;
                apiStatus.className = 'mb-4 p-2 rounded-lg api-status-compact';
                statusIndicator.className = 'w-2 h-2 rounded-full mr-2';
                const styles = {
                    connected: ['bg-green-100', 'text-green-800', 'bg-green-500'],
                    checking: ['bg-yellow-100', 'text-yellow-800', 'bg-yellow-500', 'animate-pulse'],
                    error: ['bg-red-100', 'text-red-800', 'bg-red-500']
                };
                const style = styles[status] || ['bg-gray-100', 'text-gray-600', 'bg-gray-400'];
                apiStatus.classList.add(style[0], style[1]);
                statusIndicator.classList.add(...style.slice(2));
            }

            function updateBadges() {
                if (updateCount > 0) {
                    for (let i = 1; i <= 3; i++) {
                        const badge = document.getElementById(`updateBadge${i}`);
                        if (badge) {
                            badge.textContent = `第${updateCount}次修改`;
                            badge.style.display = 'inline-block';
                        }
                    }
                }
            }

            checkIdentifierBtn.addEventListener('click', async () => {
                storeIdentifierValue = storeIdentifierInput.value.trim();
                if (!storeIdentifierValue) {
                    showIdentifierMessage('请输入门店识别码', 'error');
                    return;
                }
                
                toggleButtonLoading(checkIdentifierBtn, true);
                showIdentifierMessage('正在验证...', 'checking');

                try {
                    const statusRes = await fetch(`${CONFIG.API_BASE}/api/survey/status/${encodeURIComponent(storeIdentifierValue)}`);
                    if (!statusRes.ok) throw new Error('无法获取用户状态');
                    const statusData = await statusRes.json();
                    
                    updateCount = statusData.update_count || 0;
                    updatesRemaining = 3 - updateCount;

                    if (statusData.exists) {
                        if (updatesRemaining <= 0) {
                            showIdentifierMessage(`欢迎回来!但您的3次修改机会已用尽,无法再修改。`, 'error');
                            toggleButtonLoading(checkIdentifierBtn, false);
                            return;
                        }
                        isUpdateMode = true;
                        showIdentifierMessage(`欢迎回来!正在为您加载数据... 您还剩余 ${updatesRemaining} 次修改机会。`, 'success');
                        
                        const dataRes = await fetch(`${CONFIG.API_BASE}/api/survey/data/${encodeURIComponent(storeIdentifierValue)}`);
                        if (!dataRes.ok) throw new Error('无法加载您的历史数据');
                        const surveyData = await dataRes.json();
                        prefillForm(surveyData);

                    } else {
                        isUpdateMode = false;
                        showIdentifierMessage('欢迎新用户!请开始填写您的问卷。', 'success');
                    }

                    updateBadges();

                    setTimeout(() => {
                        currentStep++;
                        showStep(currentStep);
                        updateProgress();
                    }, 1000);

                } catch (error) {
                    showIdentifierMessage(`验证失败:${error.message}`, 'error');
                } finally {
                    toggleButtonLoading(checkIdentifierBtn, false);
                }
            });

            function showIdentifierMessage(message, type) {
                identifierMessage.textContent = message;
                const colors = {
                    success: 'text-green-600',
                    error: 'text-red-600',
                    checking: 'text-blue-600'
                };
                identifierMessage.className = `mt-4 text-sm ${colors[type] || 'text-gray-600'}`;
            }

            function prefillForm(data) {
                if (!data) return;
                const fields = collectFormData();
                for (const key in fields) {
                    const element = document.getElementById(key);
                    if (element && data[key] !== undefined && data[key] !== null) {
                        element.value = data[key];
                    }
                }
            }
            
            nextBtn.addEventListener('click', () => {
                if (validateStep(currentStep)) {
                    currentStep++;
                    showStep(currentStep);
                    updateProgress();
                }
            });
            
            prevBtn.addEventListener('click', () => {
                currentStep--;
                showStep(currentStep);
                updateProgress();
            });
            
            submitBtn.addEventListener('click', () => {
                if (validateStep(currentStep)) {
                    submitDataToBackend();
                }
            });
            
            resetForm.addEventListener('click', () => {
                if (confirm('确定要返回身份验证页面吗?当前填写或修改的内容将不会被保存。')) {
                    resetFullForm();
                }
            });
            
            downloadPDF.addEventListener('click', () => {
                if (savedData) generatePDF();
                else alert('没有找到可导出的数据');
            });
            
            function showStep(step) {
                steps.forEach((el, index) => el.classList.toggle('active', index === step));
                
                navigationButtons.classList.toggle('hidden', step === 0 || step === steps.length - 1);
                checkIdentifierBtn.parentElement.classList.toggle('hidden', step !== 0);

                if (step > 0 && step < steps.length - 1) {
                    prevBtn.classList.remove('hidden');
                    const isLastFillStep = step === steps.length - 2;
                    nextBtn.classList.toggle('hidden', isLastFillStep);
                    submitBtn.classList.toggle('hidden', !isLastFillStep);
                    submitBtn.querySelector('.submit-text').innerHTML = isUpdateMode 
                        ? '<i class="fas fa-save mr-2"></i>更新信息' 
                        : '<i class="fas fa-check-circle mr-2"></i>提交问卷';
                } else {
                     prevBtn.classList.add('hidden');
                     nextBtn.classList.add('hidden');
                     submitBtn.classList.add('hidden');
                }
            }
            
            function validateStep(step) {
                let isValid = true;
                const currentStepInputs = steps[step].querySelectorAll('input[required], select[required]');
                
                currentStepInputs.forEach(input => {
                    input.classList.remove('input-error');
                    const errorMessage = input.nextElementSibling;
                    if (errorMessage && errorMessage.classList.contains('error-message')) {
                        errorMessage.remove();
                    }
                    if (!input.value.trim()) {
                        input.classList.add('input-error');
                        const errorDiv = document.createElement('div');
                        errorDiv.className = 'error-message';
                        errorDiv.textContent = '此项为必填项';
                        input.parentNode.insertBefore(errorDiv, input.nextElementSibling);
                        isValid = false;
                    }
                });
                return isValid;
            }
            
            function updateProgress() {
                const totalFillSteps = steps.length - 2;
                const currentFillStep = currentStep - 1;
                let progress = 0;
                if(currentStep > 0 && currentStep <= totalFillSteps + 1){
                     progress = (currentFillStep / totalFillSteps) * 100;
                }
                if(currentStep === steps.length - 1){
                    progress = 100;
                }
                progressFill.style.width = `${progress}%`;
            }
            
            function resetFullForm() {
                const inputs = document.querySelectorAll('input, select');
                inputs.forEach(input => input.value = '');
                const errorMessages = document.querySelectorAll('.error-message');
                errorMessages.forEach(msg => msg.remove());
                
                currentStep = 0;
                savedData = null;
                isUpdateMode = false;
                storeIdentifierValue = '';
                updateCount = 0;
                
                for (let i = 1; i <= 3; i++) {
                    const badge = document.getElementById(`updateBadge${i}`);
                    if (badge) badge.style.display = 'none';
                }
                
                showIdentifierMessage('', '');
                showStep(currentStep);
                updateProgress();
            }
            
            async function submitDataToBackend() {
                if (!CONFIG.API_BASE || CONFIG.API_BASE.includes('your-app')) {
                    alert('系统配置错误:未设置正确的API地址');
                    return;
                }
                
                toggleButtonLoading(submitBtn, true);
                
                const formData = collectFormData();
                debugLog('Submitting form data:', formData);
                
                try {
                    const response = await fetch(`${CONFIG.API_BASE}/api/saveSurvey`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(formData),
                        signal: AbortSignal.timeout(CONFIG.TIMEOUT)
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || `HTTP ${response.status}`);
                    }
                    
                    const result = await response.json();
                    debugLog('Submit response:', result);
                    
                    savedData = { ...formData, id: result.id, timestamp: result.timestamp };
                    
                    if (isUpdateMode) {
                        updateCount++;
                        updatesRemaining--;
                    }
                    
                    showSuccessInfo();
                    
                    currentStep++;
                    showStep(currentStep);
                    updateProgress();
                    
                } catch (error) {
                    alert(`提交失败: ${error.message}`);
                } finally {
                    toggleButtonLoading(submitBtn, false);
                }
            }
            
            function showSuccessInfo() {
                if (!savedData) return;
                
                successTitle.textContent = isUpdateMode ? "信息更新成功!" : "提交成功!";
                successSubtitle.textContent = isUpdateMode ? "您的店铺数据已成功更新。" : "您的调查数据已成功保存,感谢您的参与。";

                recordId.textContent = savedData.id;
                submitTime.textContent = new Date(savedData.timestamp).toLocaleString('zh-CN');
                submitIdentifier.textContent = savedData.storeIdentifier;
                updatesRemainingEl.textContent = updatesRemaining;
            }

            function toggleButtonLoading(button, isLoading) {
                const loadingElement = button.querySelector('.loading');
                const textElement = button.querySelector('.btn-text, .submit-text');
                if (loadingElement) loadingElement.classList.toggle('active', isLoading);
                if (textElement) textElement.style.display = isLoading ? 'none' : 'flex';
                button.disabled = isLoading;
            }
            
            function collectFormData() {
                const data = {};
                const inputs = document.querySelectorAll('.form-steps input, .form-steps select');
                inputs.forEach(input => {
                    if(input.id){
                         if (input.type === 'number') data[input.id] = parseFloat(input.value) || 0;
                         else data[input.id] = input.value.trim();
                    }
                });
                data.storeIdentifier = storeIdentifierValue;
                return data;
            }
            
            function generatePDF() {
                if (!savedData) { alert('没有找到可导出的数据'); return; }
                try {
                    const doc = new jsPDF();
                    doc.setFont('helvetica');
                    doc.setFontSize(18);
                    doc.text('Restaurant Survey Data', 105, 20, { align: 'center' });
                    doc.setFontSize(12);
                    doc.text(`Record ID: ${savedData.id}`, 14, 40);
                    doc.text(`Store Identifier: ${savedData.storeIdentifier}`, 14, 50);
                    doc.text(`Store Name: ${savedData.storeName || 'N/A'}`, 14, 60);
                    doc.text(`Business Type: ${savedData.businessType || 'N/A'}`, 14, 70);
                    doc.text(`Submit Time: ${new Date(savedData.timestamp).toLocaleString()}`, 14, 80);
                    if (updateCount > 0) {
                        doc.text(`Update Count: ${updateCount}`, 14, 90);
                    }
                    const filename = `Survey_${savedData.storeIdentifier}_${new Date().toISOString().slice(0, 10)}.pdf`;
                    doc.save(filename);
                } catch (error) {
                    alert('PDF导出失败,请重试');
                }
            }
        });
    </script>
</body>
</html>

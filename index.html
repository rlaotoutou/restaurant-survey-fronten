<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>餐饮店盈利AI诊断调查问卷</title>
    <script src="https://cdn.tailwindcss.com/3.3.3"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body {
            font-family: 'Noto Sans SC', sans-serif;
            background-color: #f5f7fa;
            color: #333;
        }
        .form-step {
            display: none;
        }
        .form-step.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .progress-bar {
            height: 6px;
            background-color: #e5e7eb;
            border-radius: 3px;
        }
        .progress-fill {
            height: 100%;
            background-color: #3b82f6;
            border-radius: 3px;
            transition: width 0.3s ease;
        }
        .input-error {
            border-color: #ef4444;
        }
        .error-message {
            color: #ef4444;
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }
        .loading {
            display: none;
        }
        .loading.active {
            display: inline-flex;
            align-items: center;
        }
        .spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3b82f6;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="min-h-screen">
    <!-- API 配置面板 -->
    <div class="fixed top-4 right-4 z-50">
        <button id="configToggle" class="bg-gray-800 text-white px-3 py-2 rounded-lg hover:bg-gray-700 transition-colors">
            <i class="fas fa-cog"></i> API 配置
        </button>
    </div>

    <!-- API 配置模态框 -->
    <div id="configModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center">
        <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4">
            <h3 class="text-lg font-semibold mb-4">API 配置</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-gray-700 mb-2">后端 API 地址</label>
                    <input type="url" id="apiBaseUrl" 
                           class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                           placeholder="https://your-app.onrender.com">
                    <p class="text-gray-500 text-sm mt-1">请输入你的 Render 部署 URL（不要以 / 结尾）</p>
                </div>
                <div class="flex justify-end space-x-2">
                    <button id="cancelConfig" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">
                        取消
                    </button>
                    <button id="testConfig" class="px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600">
                        测试连接
                    </button>
                    <button id="saveConfig" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                        保存
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <div class="bg-white rounded-xl shadow-md overflow-hidden mb-8">
            <div class="p-6">
                <h1 class="text-2xl font-bold text-center text-gray-800 mb-2">餐饮店盈利AI诊断调查问卷</h1>
                <p class="text-center text-gray-600 mb-6">填写完整问卷，获取专业的盈利诊断报告</p>
                
                <!-- API 状态指示器 -->
                <div class="mb-4 p-3 rounded-lg" id="apiStatus">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <div class="w-3 h-3 rounded-full mr-2" id="statusIndicator"></div>
                            <span id="statusText">未连接到后端 API</span>
                        </div>
                        <button id="refreshStatus" class="text-blue-500 hover:text-blue-700 text-sm">
                            <i class="fas fa-refresh"></i> 刷新状态
                        </button>
                    </div>
                </div>
                
                <div class="progress-bar mb-8">
                    <div class="progress-fill" style="width: 33%"></div>
                </div>
                
                <div class="form-steps">
                    <!-- 第一步：基础信息 -->
                    <div class="form-step active" id="step1">
                        <h2 class="text-xl font-semibold mb-4 flex items-center">
                            <span class="w-8 h-8 rounded-full bg-blue-500 text-white flex items-center justify-center mr-3">1</span>
                            基础信息
                        </h2>
                        <p class="text-gray-600 mb-6">用于AI模型识别门店基本属性，为后续诊断提供基准数据</p>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-gray-700 mb-1">门店名称 <span class="text-red-500">*</span></label>
                                <input type="text" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                       placeholder="朝阳路快餐店" id="storeName" required>
                                <p class="text-gray-500 text-sm mt-1">请输入门店全称（如"XX区XX路XX餐厅"）</p>
                            </div>
                            
                            <div>
                                <label class="block text-gray-700 mb-1">业态类型 <span class="text-red-500">*</span></label>
                                <select class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" id="businessType" required>
                                    <option value="">请选择业态类型</option>
                                    <option>快餐</option>
                                    <option>火锅</option>
                                    <option>正餐</option>
                                    <option>茶餐厅</option>
                                    <option>自助餐</option>
                                    <option>烧烤</option>
                                    <option>麻辣烫</option>
                                    <option>面条</option>
                                    <option>包子饺子</option>
                                    <option>粥店</option>
                                    <option>咖啡厅</option>
                                    <option>茶饮店</option>
                                    <option>甜品店</option>
                                    <option>西餐厅</option>
                                    <option>日韩料理</option>
                                    <option>东南亚菜</option>
                                    <option>小吃摊档</option>
                                    <option>食堂档口</option>
                                    <option>酒吧</option>
                                    <option>夜宵店</option>
                                    <option>其他</option>
                                </select>
                                <p class="text-gray-500 text-sm mt-1">选择门店主要经营业态，影响行业对比基准</p>
                            </div>
                            
                            <div>
                                <label class="block text-gray-700 mb-1">营业收入（元/月） <span class="text-red-500">*</span></label>
                                <input type="number" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                       placeholder="150000" id="monthlyRevenue" required>
                                <p class="text-gray-500 text-sm mt-1">月总营业收入（含堂食、外卖及其他收入）</p>
                            </div>
                            
                            <div>
                                <label class="block text-gray-700 mb-1">食材成本（元/月） <span class="text-red-500">*</span></label>
                                <input type="number" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                       placeholder="60000" id="foodCost" required>
                                <p class="text-gray-500 text-sm mt-1">食材采购总成本（含主料、辅料、调料）</p>
                            </div>
                            
                            <div>
                                <label class="block text-gray-700 mb-1">人力成本（元/月） <span class="text-red-500">*</span></label>
                                <input type="number" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                       placeholder="50000" id="laborCost" required>
                                <p class="text-gray-500 text-sm mt-1">所有员工工资、福利、社保总和</p>
                            </div>
                            
                            <div>
                                <label class="block text-gray-700 mb-1">租金成本（元/月） <span class="text-red-500">*</span></label>
                                <input type="number" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                       placeholder="30000" id="rentCost" required>
                                <p class="text-gray-500 text-sm mt-1">含房租、物业费、水电费</p>
                            </div>
                            
                            <div>
                                <label class="block text-gray-700 mb-1">日均客流（人/天） <span class="text-red-500">*</span></label>
                                <input type="number" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                       placeholder="150" id="dailyCustomers" required>
                                <p class="text-gray-500 text-sm mt-1">平均每天到店消费人数（不含外卖）</p>
                            </div>
                            
                            <div>
                                <label class="block text-gray-700 mb-1">座位数（个） <span class="text-red-500">*</span></label>
                                <input type="number" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                       placeholder="50" id="seats" required>
                                <p class="text-gray-500 text-sm mt-1">门店总座位数量（含散座、包间）</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 第二步：运营数据 -->
                    <div class="form-step" id="step2">
                        <h2 class="text-xl font-semibold mb-4 flex items-center">
                            <span class="w-8 h-8 rounded-full bg-blue-500 text-white flex items-center justify-center mr-3">2</span>
                            运营数据
                        </h2>
                        <p class="text-gray-600 mb-6">用于AI模型分析成本结构、营收构成及运营效率</p>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-gray-700 mb-1">线上营收（元/月） <span class="text-red-500">*</span></label>
                                <input type="number" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                       placeholder="60000" id="onlineRevenue" required>
                                <p class="text-gray-500 text-sm mt-1">外卖平台总销售额（含所有外卖渠道）</p>
                            </div>
                            
                            <div>
                                <label class="block text-gray-700 mb-1">营销费用（元/月） <span class="text-red-500">*</span></label>
                                <input type="number" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                       placeholder="15000" id="marketingCost" required>
                                <p class="text-gray-500 text-sm mt-1">含广告投放、代运营、促销活动等支出</p>
                            </div>
                            
                            <div>
                                <label class="block text-gray-700 mb-1">老客户复购次数（次/月） <span class="text-red-500">*</span></label>
                                <input type="number" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                       placeholder="30" id="repeatPurchases" required>
                                <p class="text-gray-500 text-sm mt-1">老客户每月总购买次数（需会员系统数据支持）</p>
                            </div>
                            
                            <div>
                                <label class="block text-gray-700 mb-1">总客流（人/月） <span class="text-red-500">*</span></label>
                                <input type="number" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                       placeholder="4500" id="totalCustomers" required>
                                <p class="text-gray-500 text-sm mt-1">每月总接待顾客数量（含新老客户）</p>
                            </div>
                            
                            <div>
                                <label class="block text-gray-700 mb-1">水电气成本（元/月） <span class="text-red-500">*</span></label>
                                <input type="number" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                       placeholder="8000" id="utilityCost" required>
                                <p class="text-gray-500 text-sm mt-1">水费、电费、燃气费总和</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 第三步：体验数据 -->
                    <div class="form-step" id="step3">
                        <h2 class="text-xl font-semibold mb-4 flex items-center">
                            <span class="w-8 h-8 rounded-full bg-blue-500 text-white flex items-center justify-center mr-3">3</span>
                            体验数据
                        </h2>
                        <p class="text-gray-600 mb-6">用于AI模型评估客户满意度及口碑健康度</p>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-gray-700 mb-1">各平台团购均评分（抖音/美团/大众点评） <span class="text-red-500">*</span></label>
                                <input type="number" step="0.1" min="0" max="5" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                       placeholder="3.8" id="averageRating" required>
                                <p class="text-gray-500 text-sm mt-1">综合各平台评分（精确到0.1分）</p>
                            </div>
                            
                            <div>
                                <label class="block text-gray-700 mb-1">差评数（条/月） <span class="text-red-500">*</span></label>
                                <input type="number" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                       placeholder="25" id="badReviews" required>
                                <p class="text-gray-500 text-sm mt-1">每月收到的1-2星评价总数</p>
                            </div>
                            
                            <div>
                                <label class="block text-gray-700 mb-1">总评论数（条/月） <span class="text-red-500">*</span></label>
                                <input type="number" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                       placeholder="400" id="totalReviews" required>
                                <p class="text-gray-500 text-sm mt-1">每月收到的所有评价总数（含好评、中评、差评）</p>
                            </div>
                            
                            <div>
                                <label class="block text-gray-700 mb-1">社交媒体提及量（次/月） <span class="text-red-500">*</span></label>
                                <input type="number" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                       placeholder="80" id="socialMediaMentions" required>
                                <p class="text-gray-500 text-sm mt-1">商家短视频发布量+用户自发提及量总和</p>
                            </div>
                            
                            <div>
                                <label class="block text-gray-700 mb-1">服务差评占比（%） <span class="text-red-500">*</span></label>
                                <input type="number" min="0" max="100" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                       placeholder="40" id="serviceBadReviewRate" required>
                                <p class="text-gray-500 text-sm mt-1">因服务问题导致的差评占总差评的比例</p>
                            </div>
                            
                            <div>
                                <label class="block text-gray-700 mb-1">口味差评占比（%） <span class="text-red-500">*</span></label>
                                <input type="number" min="0" max="100" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                       placeholder="30" id="tasteBadReviewRate" required>
                                <p class="text-gray-500 text-sm mt-1">因口味问题导致的差评占总差评的比例</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 数据说明 -->
                    <div class="form-step" id="step4">
                        <div class="max-w-4xl mx-auto">
                            <!-- 标题 -->
                            <div class="text-center mb-8">
                                <h1 class="text-3xl font-bold text-gray-800 mb-4">餐饮店盈利AI诊断调查问卷</h1>
                                <p class="text-gray-600">填写完整问卷，获取专业的盈利诊断报告</p>
                            </div>
                            
                            <!-- 数据整合保存及输出说明 -->
                            <div class="bg-blue-50 rounded-xl p-8 mb-8">
                                <h2 class="text-2xl font-bold text-blue-800 mb-6">数据整合保存及输出说明</h2>
                                
                                <div class="space-y-6">
                                    <div>
                                        <h3 class="text-lg font-semibold text-blue-700 mb-2">数据保存</h3>
                                        <p class="text-gray-700">所有输入数据将通过加密方式存储于专用服务器，仅用于AI诊断模型分析，严格遵守《个人信息保护法》，数据保留期限为1年。</p>
                                    </div>
                                    
                                    <div>
                                        <h3 class="text-lg font-semibold text-blue-700 mb-2">数据整合</h3>
                                        <p class="text-gray-700">系统将自动计算核心指标（如食材成本率、翻台率、差评率等），并与同业态行业标杆数据对比，定位经营问题根因。</p>
                                    </div>
                                    
                                    <div>
                                        <h3 class="text-lg font-semibold text-blue-700 mb-2">输出方式</h3>
                                        <ul class="text-gray-700 space-y-2">
                                            <li class="flex items-start">
                                                <span class="w-2 h-2 bg-blue-500 rounded-full mt-2 mr-3 flex-shrink-0"></span>
                                                <span><strong>诊断报告：</strong>生成HTML格式的《餐饮店盈利健康诊断报告》，包含健康状态红绿灯表、行业对比雷达图、问题根因分析及行动建议</span>
                                            </li>
                                            <li class="flex items-start">
                                                <span class="w-2 h-2 bg-blue-500 rounded-full mt-2 mr-3 flex-shrink-0"></span>
                                                <span><strong>可视化呈现：</strong>关键指标（如毛利率、翻台率）将以图表形式展示，支持下载打印</span>
                                            </li>
                                            <li class="flex items-start">
                                                <span class="w-2 h-2 bg-blue-500 rounded-full mt-2 mr-3 flex-shrink-0"></span>
                                                <span><strong>行动指南：</strong>针对异常指标提供优先级排序的改进方案，包含投入成本、预期效果及实施步骤</span>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 成功提交信息 -->
                            <div id="successMessage" class="bg-green-50 rounded-xl p-6 border border-green-200 hidden">
                                <div class="flex items-center mb-4">
                                    <i class="fas fa-check-circle text-green-500 text-2xl mr-3"></i>
                                    <h3 class="text-lg font-semibold text-green-800">提交成功！</h3>
                                </div>
                                <p class="text-green-700 mb-4">您的数据已成功保存到后端系统。</p>
                                <div class="text-sm text-green-600">
                                    <p>记录ID: <span id="recordId" class="font-mono"></span></p>
                                    <p>提交时间: <span id="submitTime" class="font-mono"></span></p>
                                </div>
                            </div>
                            
                            <!-- 注释 -->
                            <div class="text-center text-sm text-gray-500 bg-gray-100 rounded-lg p-4">
                                注：数据来源于餐饮店盈利AI诊断数据模型，所有指标阈值参考餐饮行业通用标准及细分业态标杆数据。
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="flex justify-between mt-8">
                    <button id="prevBtn" class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors hidden">
                        <i class="fas fa-arrow-left mr-2"></i>上一步
                    </button>
                    <button id="exportBtn" class="px-6 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 transition-colors hidden">
                        <i class="fas fa-file-pdf mr-2"></i>导出PDF
                    </button>
                    <button id="nextBtn" class="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors ml-auto">
                        下一步<i class="fas fa-arrow-right ml-2"></i>
                    </button>
                    <button id="submitBtn" class="px-6 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors hidden">
                        <div class="loading">
                            <div class="spinner"></div>
                            提交中...
                        </div>
                        <span class="submit-text">
                            <i class="fas fa-check-circle mr-2"></i>提交到后端
                        </span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <footer class="bg-gray-100 py-4 mt-8">
        <div class="container mx-auto px-4 text-center text-gray-600 text-sm">
            <p>created by <a href="https://space.coze.cn" class="text-blue-500 hover:underline">coze space</a></p>
            <p class="mt-1">页面内容均由 AI 生成，仅供参考</p>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const { jsPDF } = window.jspdf;
            const steps = document.querySelectorAll('.form-step');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const submitBtn = document.getElementById('submitBtn');
            const exportBtn = document.getElementById('exportBtn');
            const progressFill = document.querySelector('.progress-fill');
            
            // API 配置相关元素
            const configToggle = document.getElementById('configToggle');
            const configModal = document.getElementById('configModal');
            const apiBaseUrl = document.getElementById('apiBaseUrl');
            const cancelConfig = document.getElementById('cancelConfig');
            const saveConfig = document.getElementById('saveConfig');
            const testConfig = document.getElementById('testConfig');
            const apiStatus = document.getElementById('apiStatus');
            const statusIndicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('statusText');
            const refreshStatus = document.getElementById('refreshStatus');
            
            let currentStep = 0;
            let API_BASE = ''; // 这里是关键：API_BASE 变量
            let savedData = [];

            // 初始化显示第一步
            showStep(currentStep);
            loadApiConfig();
            
            // ============ API 配置相关功能 ============
            
            // 加载保存的 API 配置
            function loadApiConfig() {
                // 在实际使用中，你可以在这里设置默认的 Render URL
                const defaultApiUrl = ''; // 设置你的默认 Render URL，例如: 'https://your-app.onrender.com'
                
                if (defaultApiUrl) {
                    API_BASE = defaultApiUrl;
                    apiBaseUrl.value = defaultApiUrl;
                    checkApiConnection();
                } else {
                    updateApiStatus('disconnected', '请配置后端 API 地址');
                }
            }
            
            // 显示/隐藏配置模态框
            configToggle.addEventListener('click', () => {
                configModal.classList.remove('hidden');
            });
            
            cancelConfig.addEventListener('click', () => {
                configModal.classList.add('hidden');
            });
            
            // 测试连接按钮
            testConfig.addEventListener('click', async () => {
                const url = apiBaseUrl.value.trim();
                if (!url) {
                    alert('请输入有效的 API 地址');
                    return;
                }
                
                let formattedUrl = formatApiUrl(url);
                await testApiConnection(formattedUrl);
            });
            
            // 保存 API 配置
            saveConfig.addEventListener('click', () => {
                const url = apiBaseUrl.value.trim();
                if (!url) {
                    alert('请输入有效的 API 地址');
                    return;
                }
                
                let formattedUrl = formatApiUrl(url);
                API_BASE = formattedUrl;
                configModal.classList.add('hidden');
                checkApiConnection();
            });
            
            // 刷新状态按钮
            refreshStatus.addEventListener('click', () => {
                if (API_BASE) {
                    checkApiConnection();
                } else {
                    alert('请先配置 API 地址');
                }
            });
            
            // 格式化 API URL
            function formatApiUrl(url) {
                let formattedUrl = url.trim();
                
                // 确保有协议
                if (!formattedUrl.startsWith('http://') && !formattedUrl.startsWith('https://')) {
                    formattedUrl = 'https://' + formattedUrl;
                }
                
                // 移除末尾的斜杠
                formattedUrl = formattedUrl.replace(/\/$/, '');
                
                return formattedUrl;
            }
            
            // 测试 API 连接
            async function testApiConnection(url) {
                updateApiStatus('checking', '正在测试连接...');
                
                try {
                    // 使用正确的健康检查端点
                    const response = await fetch(`${url}/api/health`, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        signal: AbortSignal.timeout(15000) // 15秒超时
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        updateApiStatus('connected', `连接成功！服务器时间: ${new Date(data.time).toLocaleString()}`);
                        return true;
                    } else {
                        const errorText = await response.text();
                        throw new Error(`HTTP ${response.status}: ${errorText}`);
                    }
                } catch (error) {
                    console.error('API connection test failed:', error);
                    let errorMessage = '连接失败: ';
                    
                    if (error.name === 'AbortError' || error.name === 'TimeoutError') {
                        errorMessage += '请求超时，请检查 URL 是否正确';
                    } else if (error.message.includes('CORS')) {
                        errorMessage += 'CORS 错误，请检查后端 CORS 配置';
                    } else if (error.message.includes('fetch')) {
                        errorMessage += '网络错误，请检查 URL 和网络连接';
                    } else {
                        errorMessage += error.message;
                    }
                    
                    updateApiStatus('error', errorMessage);
                    return false;
                }
            }
            
            // 检查 API 连接状态
            async function checkApiConnection() {
                if (!API_BASE) {
                    updateApiStatus('disconnected', '未配置 API 地址');
                    return;
                }
                
                await testApiConnection(API_BASE);
            }
            
            // 更新 API 状态显示
            function updateApiStatus(status, message) {
                statusText.textContent = message;
                
                // 重置所有状态类
                apiStatus.className = 'mb-4 p-3 rounded-lg';
                statusIndicator.className = 'w-3 h-3 rounded-full mr-2';
                
                switch(status) {
                    case 'connected':
                        apiStatus.classList.add('bg-green-100', 'text-green-800');
                        statusIndicator.classList.add('bg-green-500');
                        break;
                    case 'checking':
                        apiStatus.classList.add('bg-yellow-100', 'text-yellow-800');
                        statusIndicator.classList.add('bg-yellow-500', 'animate-pulse');
                        break;
                    case 'error':
                        apiStatus.classList.add('bg-red-100', 'text-red-800');
                        statusIndicator.classList.add('bg-red-500');
                        break;
                    default: // disconnected
                        apiStatus.classList.add('bg-gray-100', 'text-gray-600');
                        statusIndicator.classList.add('bg-gray-400');
                }
            }
            
            // ============ 表单导航功能 ============
            
            // 下一步按钮点击事件
            nextBtn.addEventListener('click', function() {
                if (validateStep(currentStep)) {
                    currentStep++;
                    showStep(currentStep);
                    updateProgress();
                }
            });
            
            // 上一步按钮点击事件
            prevBtn.addEventListener('click', function() {
                currentStep--;
                showStep(currentStep);
                updateProgress();
            });
            
            // 提交数据按钮点击事件
            submitBtn.addEventListener('click', async function() {
                if (validateStep(currentStep)) {
                    await submitDataToBackend();
                }
            });
            
            // 导出PDF按钮点击事件
            exportBtn.addEventListener('click', function() {
                generatePDF();
            });
            
            // 显示当前步骤
            function showStep(step) {
                steps.forEach((stepElement, index) => {
                    if (index === step) {
                        stepElement.classList.add('active');
                    } else {
                        stepElement.classList.remove('active');
                    }
                });
                
                // 控制按钮显示
                if (step === 0) {
                    prevBtn.classList.add('hidden');
                    exportBtn.classList.add('hidden');
                } else {
                    prevBtn.classList.remove('hidden');
                    exportBtn.classList.remove('hidden');
                }
                
                if (step === steps.length - 2) {
                    nextBtn.classList.add('hidden');
                    submitBtn.classList.remove('hidden');
                } else if (step === steps.length - 1) {
                    nextBtn.classList.add('hidden');
                    submitBtn.classList.add('hidden');
                    prevBtn.classList.remove('hidden'); // 允许返回上一步
                } else {
                    nextBtn.classList.remove('hidden');
                    submitBtn.classList.add('hidden');
                }
            }
            
            // 验证当前步骤
            function validateStep(step) {
                let isValid = true;
                const currentStepInputs = steps[step].querySelectorAll('input[required], select[required]');
                
                currentStepInputs.forEach(input => {
                    input.classList.remove('input-error');
                    const errorMessage = input.nextElementSibling;
                    if (errorMessage && errorMessage.classList.contains('error-message')) {
                        errorMessage.remove();
                    }
                    
                    if (!input.value) {
                        input.classList.add('input-error');
                        const errorDiv = document.createElement('div');
                        errorDiv.className = 'error-message';
                        errorDiv.textContent = '此项为必填项';
                        input.parentNode.insertBefore(errorDiv, input.nextElementSibling);
                        isValid = false;
                    } else if (input.type === 'number' && input.hasAttribute('min') && input.hasAttribute('max')) {
                        const value = parseFloat(input.value);
                        const min = parseFloat(input.getAttribute('min'));
                        const max = parseFloat(input.getAttribute('max'));
                        
                        if (value < min || value > max) {
                            input.classList.add('input-error');
                            const errorDiv = document.createElement('div');
                            errorDiv.className = 'error-message';
                            errorDiv.textContent = `请输入${min}到${max}之间的数值`;
                            input.parentNode.insertBefore(errorDiv, input.nextElementSibling);
                            isValid = false;
                        }
                    }
                });
                
                return isValid;
            }
            
            // 更新进度条
            function updateProgress() {
                const progress = (currentStep / (steps.length - 1)) * 100;
                progressFill.style.width = `${progress}%`;
            }
            
            // ============ 数据提交功能 ============
            
            // 提交数据到后端
            async function submitDataToBackend() {
                if (!API_BASE) {
                    alert('请先配置后端 API 地址');
                    configModal.classList.remove('hidden');
                    return;
                }
                
                // 显示加载状态
                toggleSubmitLoading(true);
                
                // 收集表单数据
                const formData = collectFormData();
                
                try {
                    const response = await fetch(`${API_BASE}/api/saveSurvey`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(formData),
                        signal: AbortSignal.timeout(30000) // 30秒超时
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        
                        // 保存数据到内存
                        const savedRecord = {
                            ...formData,
                            id: result.id || Date.now(),
                            timestamp: result.timestamp || new Date().toISOString()
                        };
                        savedData.push(savedRecord);
                        
                        // 显示成功信息
                        showSuccessMessage(savedRecord);
                        
                        // 跳转到最后一步
                        currentStep++;
                        showStep(currentStep);
                        updateProgress();
                        
                    } else {
                        let errorMessage = `HTTP ${response.status}`;
                        try {
                            const errorData = await response.json();
                            errorMessage = errorData.error || errorData.message || errorMessage;
                        } catch (e) {
                            errorMessage += ': ' + await response.text();
                        }
                        throw new Error(errorMessage);
                    }
                    
                } catch (error) {
                    console.error('提交失败:', error);
                    
                    let userMessage = '提交失败: ';
                    if (error.name === 'AbortError' || error.name === 'TimeoutError') {
                        userMessage += '请求超时，请重试';
                    } else if (error.message.includes('CORS')) {
                        userMessage += 'CORS 错误，请联系管理员检查后端配置';
                    } else if (error.message.includes('fetch')) {
                        userMessage += '网络错误，请检查网络连接';
                    } else {
                        userMessage += error.message;
                    }
                    
                    alert(userMessage + '\n\n请检查：\n1. 网络连接是否正常\n2. API 地址是否正确\n3. 后端服务是否运行正常');
                } finally {
                    toggleSubmitLoading(false);
                }
            }
            
            // 显示成功消息
            function showSuccessMessage(record) {
                const successMessage = document.getElementById('successMessage');
                const recordId = document.getElementById('recordId');
                const submitTime = document.getElementById('submitTime');
                
                recordId.textContent = record.id;
                submitTime.textContent = new Date(record.timestamp).toLocaleString();
                successMessage.classList.remove('hidden');
            }
            
            // 切换提交按钮加载状态
            function toggleSubmitLoading(loading) {
                const loadingElement = submitBtn.querySelector('.loading');
                const textElement = submitBtn.querySelector('.submit-text');
                
                if (loading) {
                    loadingElement.classList.add('active');
                    textElement.style.display = 'none';
                    submitBtn.disabled = true;
                } else {
                    loadingElement.classList.remove('active');
                    textElement.style.display = 'flex';
                    submitBtn.disabled = false;
                }
            }
            
            // 收集表单数据
            function collectFormData() {
                return {
                    storeName: document.getElementById('storeName').value,
                    businessType: document.getElementById('businessType').value,
                    monthlyRevenue: parseFloat(document.getElementById('monthlyRevenue').value) || 0,
                    foodCost: parseFloat(document.getElementById('foodCost').value) || 0,
                    laborCost: parseFloat(document.getElementById('laborCost').value) || 0,
                    rentCost: parseFloat(document.getElementById('rentCost').value) || 0,
                    dailyCustomers: parseInt(document.getElementById('dailyCustomers').value) || 0,
                    seats: parseInt(document.getElementById('seats').value) || 0,
                    onlineRevenue: parseFloat(document.getElementById('onlineRevenue').value) || 0,
                    marketingCost: parseFloat(document.getElementById('marketingCost').value) || 0,
                    repeatPurchases: parseInt(document.getElementById('repeatPurchases').value) || 0,
                    totalCustomers: parseInt(document.getElementById('totalCustomers').value) || 0,
                    utilityCost: parseFloat(document.getElementById('utilityCost').value) || 0,
                    averageRating: parseFloat(document.getElementById('averageRating').value) || 0,
                    badReviews: parseInt(document.getElementById('badReviews').value) || 0,
                    totalReviews: parseInt(document.getElementById('totalReviews').value) || 0,
                    socialMediaMentions: parseInt(document.getElementById('socialMediaMentions').value) || 0,
                    serviceBadReviewRate: parseFloat(document.getElementById('serviceBadReviewRate').value) || 0,
                    tasteBadReviewRate: parseFloat(document.getElementById('tasteBadReviewRate').value) || 0
                };
            }
            
            // ============ PDF 导出功能 ============
            
            // 生成PDF文件
            function generatePDF() {
                if (savedData.length === 0) {
                    alert('没有找到可导出的数据！请先提交数据。');
                    return;
                }
                
                // 创建PDF文档
                const doc = new jsPDF();
                
                // 设置字体
                doc.setFont('helvetica');
                
                // 添加标题
                doc.setFontSize(18);
                doc.setTextColor(40, 40, 40);
                doc.text('Restaurant Profit Diagnosis Survey Data', 105, 20, { align: 'center' });
                doc.text('餐饮店盈利AI诊断调查问卷数据', 105, 30, { align: 'center' });
                
                // 添加日期
                doc.setFontSize(12);
                doc.text(`Export Date: ${new Date().toLocaleDateString()}`, 105, 40, { align: 'center' });
                
                // 添加数据表格
                let y = 60;
                
                savedData.forEach((item, index) => {
                    // 检查是否需要添加新页面
                    if (y > 250) {
                        doc.addPage();
                        y = 30;
                    }
                    
                    // 添加记录标题
                    doc.setFontSize(14);
                    doc.setTextColor(40, 40, 40);
                    doc.text(`Record ${index + 1} (ID: ${item.id})`, 14, y);
                    y += 7;
                    doc.text(`Submit Time: ${new Date(item.timestamp).toLocaleString()}`, 14, y);
                    y += 10;
                    
                    // 设置表格样式
                    doc.setFontSize(10);
                    doc.setTextColor(80, 80, 80);
                    
                    // 基础信息
                    doc.text('Basic Information:', 14, y);
                    y += 7;
                    
                    const basicInfo = [
                        `Store Name: ${item.storeName || 'Not filled'}`,
                        `Business Type: ${item.businessType || 'Not filled'}`,
                        `Monthly Revenue: ${item.monthlyRevenue || 0} yuan/month`,
                        `Food Cost: ${item.foodCost || 0} yuan/month`,
                        `Labor Cost: ${item.laborCost || 0} yuan/month`,
                        `Rent Cost: ${item.rentCost || 0} yuan/month`,
                        `Daily Customers: ${item.dailyCustomers || 0} people/day`,
                        `Seats: ${item.seats || 0} seats`
                    ];
                    
                    basicInfo.forEach(info => {
                        doc.text(info, 20, y);
                        y += 6;
                    });
                    y += 4;
                    
                    // 运营数据
                    doc.text('Operation Data:', 14, y);
                    y += 7;
                    
                    const operationData = [
                        `Online Revenue: ${item.onlineRevenue || 0} yuan/month`,
                        `Marketing Cost: ${item.marketingCost || 0} yuan/month`,
                        `Repeat Purchases: ${item.repeatPurchases || 0} times/month`,
                        `Total Customers: ${item.totalCustomers || 0} people/month`,
                        `Utility Cost: ${item.utilityCost || 0} yuan/month`
                    ];
                    
                    operationData.forEach(data => {
                        doc.text(data, 20, y);
                        y += 6;
                    });
                    y += 4;
                    
                    // 体验数据
                    doc.text('Experience Data:', 14, y);
                    y += 7;
                    
                    const experienceData = [
                        `Average Rating: ${item.averageRating || 0} stars`,
                        `Bad Reviews: ${item.badReviews || 0} reviews/month`,
                        `Total Reviews: ${item.totalReviews || 0} reviews/month`,
                        `Social Media Mentions: ${item.socialMediaMentions || 0} times/month`,
                        `Service Bad Review Rate: ${item.serviceBadReviewRate || 0}%`,
                        `Taste Bad Review Rate: ${item.tasteBadReviewRate || 0}%`
                    ];
                    
                    experienceData.forEach(data => {
                        doc.text(data, 20, y);
                        y += 6;
                    });
                    y += 15;
                });
                
                // 添加页脚说明
                const totalPages = doc.internal.getNumberOfPages();
                for (let i = 1; i <= totalPages; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.setTextColor(100, 100, 100);
                    doc.text(`Page ${i} of ${totalPages}`, 105, 290, { align: 'center' });
                    doc.text('Data source: Restaurant Profit AI Diagnosis Survey System', 105, 285, { align: 'center' });
                }
                
                // 保存PDF文件
                const filename = `Restaurant_Survey_Data_${new Date().toISOString().slice(0, 10)}.pdf`;
                doc.save(filename);
            }
        });
    </script>
</body>
</html>
